\i sql/bson_expr_index_pushdown_tests.sql
SET search_path TO documentdb_api,documentdb_api_catalog,documentdb_core;
SET documentdb.next_collection_id TO 200;
SET documentdb.next_collection_index_id TO 200;
SELECT COUNT(documentdb_api.insert_one('exprdb', 'exprcoll', bson_build_document('_id'::text, i, 'a'::text, i, 'b'::text, i))) FROM generate_series(1, 1000) i;
psql:sql/bson_expr_index_pushdown_tests.sql:6: NOTICE:  creating collection
 count 
-------
  1000
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('exprdb', '{ "createIndexes": "exprcoll", "indexes": [ { "key": { "a": 1 }, "name": "a_1", "enableOrderedIndex": true }] }', TRUE);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('exprdb', '{ "createIndexes": "exprcoll", "indexes": [ { "key": { "b": 1 }, "name": "b_1", "enableOrderedIndex": false }] }', TRUE);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "2" }, "numIndexesAfter" : { "$numberInt" : "3" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- no pushdown for arbitrary operators
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$isArray": "$a" } } }');
                                                                                 QUERY PLAN                                                                                  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Recheck Cond: (shard_key_value = '201'::bigint)
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$isArray" : "$a" } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on _id_
         Index Cond: (shard_key_value = '201'::bigint)
(5 rows)

-- pushdown does not work for a non-ordered index
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$eq": [ "$b", 10 ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Recheck Cond: (shard_key_value = '201'::bigint)
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$eq" : [ "$b", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on _id_
         Index Cond: (shard_key_value = '201'::bigint)
(5 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$eq": [ 10, "$b" ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Recheck Cond: (shard_key_value = '201'::bigint)
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$eq" : [ { "$numberInt" : "10" }, "$b" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on _id_
         Index Cond: (shard_key_value = '201'::bigint)
(5 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gt": [ "$b", 10 ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Recheck Cond: (shard_key_value = '201'::bigint)
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$gt" : [ "$b", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on _id_
         Index Cond: (shard_key_value = '201'::bigint)
(5 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gt": [ 10, "$b" ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Recheck Cond: (shard_key_value = '201'::bigint)
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$gt" : [ { "$numberInt" : "10" }, "$b" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on _id_
         Index Cond: (shard_key_value = '201'::bigint)
(5 rows)

-- simple pushdown of operators
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$eq": [ "$a", 10 ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$eq" : [ "$a", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @= '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$eq": [ 10, "$a" ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$eq" : [ { "$numberInt" : "10" }, "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @= '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gt": [ "$a", 10 ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$gt" : [ "$a", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @> '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gt": [ 10, "$a" ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$gt" : [ { "$numberInt" : "10" }, "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @<= '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gte": [ "$a", 10 ] } } }');
                                                                                              QUERY PLAN                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$gte" : [ "$a", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @>= '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gte": [ 10, "$a" ] } } }');
                                                                                              QUERY PLAN                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$gte" : [ { "$numberInt" : "10" }, "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @< '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lt": [ "$a", 10 ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$lt" : [ "$a", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @< '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lt": [ 10, "$a" ] } } }');
                                                                                             QUERY PLAN                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$lt" : [ { "$numberInt" : "10" }, "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @>= '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lte": [ "$a", 10 ] } } }');
                                                                                              QUERY PLAN                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$lte" : [ "$a", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @<= '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lte": [ 10, "$a" ] } } }');
                                                                                              QUERY PLAN                                                                                              
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$lte" : [ { "$numberInt" : "10" }, "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @> '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

-- partial pushdown if it's conjunction
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$and": [ { "$lt": [ "$a", 10 ] }, { "$isArray": "$c" } ] } } }');
                                                                                                                 QUERY PLAN                                                                                                                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$and" : [ { "$lt" : [ "$a", { "$numberInt" : "10" } ] }, { "$isArray" : "$c" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @< '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$and": [ { "$lt": [ "$a", 10 ] }, { "$gt": [ "$b", 6 ] } ] } } }');
                                                                                                                             QUERY PLAN                                                                                                                             
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$and" : [ { "$lt" : [ "$a", { "$numberInt" : "10" } ] }, { "$gt" : [ "$b", { "$numberInt" : "6" } ] } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @< '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$and": [ { "$lt": [ "$a", 10 ] }, { "$or": [ { "$eq": [ "$a", 5 ] }, { "$lt": [ "$a", 6 ] } ] } ] } } }');
                                                                                                                                                            QUERY PLAN                                                                                                                                                            
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$and" : [ { "$lt" : [ "$a", { "$numberInt" : "10" } ] }, { "$or" : [ { "$eq" : [ "$a", { "$numberInt" : "5" } ] }, { "$lt" : [ "$a", { "$numberInt" : "6" } ] } ] } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @< '{ "a" : { "$numberInt" : "10" } }'::bson)
(4 rows)

-- full pushdown of supported conjunction
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$and": [ { "$lt": [ "$a", 10 ] }, { "$gt": [ "$a", 5 ] } ] } } }');
                                                                                                                             QUERY PLAN                                                                                                                             
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Index Scan using a_1 on documents_201 collection
   Index Cond: ((document @< '{ "a" : { "$numberInt" : "10" } }'::bson) AND (document @> '{ "a" : { "$numberInt" : "5" } }'::bson))
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$and" : [ { "$lt" : [ "$a", { "$numberInt" : "10" } ] }, { "$gt" : [ "$a", { "$numberInt" : "5" } ] } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
(3 rows)

-- pushdown of expressions that evaluate to constants
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lt": [ { "$add": [ 2, 3 ] }, "$a" ] } } }');
                                                                                                                 QUERY PLAN                                                                                                                  
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$lt" : [ { "$add" : [ { "$numberInt" : "2" }, { "$numberInt" : "3" } ] }, "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @>= '{ "a" : { "$numberInt" : "5" } }'::bson)
(4 rows)

-- Support pushdown of expressions that are variables.
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lt": [ "$$myvar", "$a" ] } }, "let": { "myvar": 3 } }');
                                                                                                                      QUERY PLAN                                                                                                                      
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$lt" : [ "$$myvar", "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE, "let" : { "myvar" : { "$literal" : { "$numberInt" : "3" } } } }'::bson)
   ->  Bitmap Index Scan on a_1
         Index Cond: (document @>= '{ "a" : { "$numberInt" : "3" } }'::bson)
(4 rows)

-- TODO: Support pushdown of expressions that evaluate to constants with variables.
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lt": [ { "$add": [ 2, "$$myvar" ] }, "$a" ] } }, "let": { "myvar": 3 } }');
                                                                                                                                          QUERY PLAN                                                                                                                                           
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Bitmap Heap Scan on documents_201 collection
   Recheck Cond: (shard_key_value = '201'::bigint)
   Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$lt" : [ { "$add" : [ { "$numberInt" : "2" }, "$$myvar" ] }, "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE, "let" : { "myvar" : { "$literal" : { "$numberInt" : "3" } } } }'::bson)
   ->  Bitmap Index Scan on _id_
         Index Cond: (shard_key_value = '201'::bigint)
(5 rows)

set documentdb.enableExtendedExplainPlans to on;
EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lt": [ "$$myvar", "$a" ] } }, "let": { "myvar": 3 } }');
                                                                                                                         QUERY PLAN                                                                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=997.00 loops=1)
   indexName: a_1
   isMultiKey: false
   indexBounds: ["a": [3, Infinity]]
   innerScanLoops: 998 loops
   scanType: regular
   scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 998)]
   ->  Bitmap Heap Scan on documents_201 collection (actual rows=997.00 loops=1)
         Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$lt" : [ "$$myvar", "$a" ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE, "let" : { "myvar" : { "$literal" : { "$numberInt" : "3" } } } }'::bson)
         Rows Removed by Filter: 1
         Heap Blocks: exact=11
         ->  Bitmap Index Scan on a_1 (actual rows=998.00 loops=1)
               Index Cond: (document @>= '{ "a" : { "$numberInt" : "3" } }'::bson)
               Index Searches: 0
(14 rows)

-- now try with $lookup
SELECT COUNT(documentdb_api.insert_one('exprdb', 'exprcollright', bson_build_document('_id'::text, i, 'a'::text, i, 'b'::text, i))) FROM generate_series(1, 1000) i;
psql:sql/bson_expr_index_pushdown_tests.sql:58: NOTICE:  creating collection
 count 
-------
  1000
(1 row)

SELECT documentdb_api_internal.create_indexes_non_concurrently('exprdb', '{ "createIndexes": "exprcollright", "indexes": [ { "key": { "a": 1 }, "name": "a_1", "enableOrderedIndex": true }] }', TRUE);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "1" }, "numIndexesAfter" : { "$numberInt" : "2" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

-- standard lookup
EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_pipeline('exprdb',
    '{ "aggregate": "exprcoll", "pipeline":[ { "$match": { "$expr": { "$gte": [ "$a", 10 ] } } }, { "$lookup": { "from": "exprcollright", "as": "res", "localField": "a", "foreignField": "a" } } ] }');
                                                                                                        QUERY PLAN                                                                                                         
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Nested Loop (actual rows=991.00 loops=1)
   ->  Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=991.00 loops=1)
         indexName: a_1
         isMultiKey: false
         indexBounds: ["a": [10, Infinity]]
         innerScanLoops: 991 loops
         scanType: regular
         scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 991)]
         ->  Bitmap Heap Scan on documents_201 collection (actual rows=991.00 loops=1)
               Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$gte" : [ "$a", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
               Heap Blocks: exact=11
               ->  Bitmap Index Scan on a_1 (actual rows=991.00 loops=1)
                     Index Cond: (document @>= '{ "a" : { "$numberInt" : "10" } }'::bson)
                     Index Searches: 0
   ->  Aggregate (actual rows=1.00 loops=991)
         ->  Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1.00 loops=991)
               indexName: a_1
               isMultiKey: false
               indexBounds: ["a": [1000, 1000]]
               innerScanLoops: 991 loops
               scanType: regular
               scanKeyDetails: key 1: [(isInequality: false, estimatedEntryCount: 1)]
               ->  Bitmap Heap Scan on documents_202 collection_0_1 (actual rows=1.00 loops=991)
                     Filter: documentdb_api_internal.bson_dollar_lookup_join_filter(document, documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(collection.document, '{ "a" : "a" }'::bson), 'a'::text)
                     Heap Blocks: exact=991
                     ->  Bitmap Index Scan on a_1 (actual rows=1.00 loops=991)
                           Index Cond: (document @*= documentdb_api_internal.bson_dollar_lookup_extract_filter_expression(collection.document, '{ "a" : "a" }'::bson))
                           Index Searches: 0
(28 rows)

-- lookup with let
EXPLAIN (COSTS OFF, ANALYZE ON, SUMMARY OFF, TIMING OFF, BUFFERS OFF) SELECT document FROM bson_aggregation_pipeline('exprdb',
    '{ "aggregate": "exprcoll", "pipeline":[ { "$match": { "$expr": { "$gte": [ "$a", 10 ] } } }, { "$lookup": { "from": "exprcollright", "as": "res", "let": { "myvar": "$a" }, "pipeline": [ { "$match": { "$expr": { "$eq": [ "$a", "$$myvar" ] } } } ] } } ] }');
                                                                                                                                                                QUERY PLAN                                                                                                                                                                 
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Nested Loop (actual rows=991.00 loops=1)
   ->  Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=991.00 loops=1)
         indexName: a_1
         isMultiKey: false
         indexBounds: ["a": [10, Infinity]]
         innerScanLoops: 991 loops
         scanType: regular
         scanKeyDetails: key 1: [(isInequality: true, estimatedEntryCount: 991)]
         ->  Bitmap Heap Scan on documents_201 collection (actual rows=991.00 loops=1)
               Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$gte" : [ "$a", { "$numberInt" : "10" } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
               Heap Blocks: exact=11
               ->  Bitmap Index Scan on a_1 (actual rows=991.00 loops=1)
                     Index Cond: (document @>= '{ "a" : { "$numberInt" : "10" } }'::bson)
                     Index Searches: 0
   ->  Aggregate (actual rows=1.00 loops=991)
         ->  Custom Scan (DocumentDBApiExplainQueryScan) (actual rows=1.00 loops=991)
               indexName: a_1
               isMultiKey: false
               indexBounds: ["a": [1000, 1000]]
               innerScanLoops: 991 loops
               scanType: regular
               scanKeyDetails: key 1: [(isInequality: false, estimatedEntryCount: 1)]
               ->  Bitmap Heap Scan on documents_202 collection_0_1 (actual rows=1.00 loops=991)
                     Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$eq" : [ "$a", "$$myvar" ] } }'::bson, documentdb_api_internal.bson_dollar_lookup_expression_eval_merge(collection.document, '{ "myvar" : "$a" }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson))
                     Heap Blocks: exact=991
                     ->  Bitmap Index Scan on a_1 (actual rows=1.00 loops=991)
                           Index Cond: (document @= documentdb_api_internal.bson_expression_get('{ }'::bson, '{ "a" : "$$myvar" }'::bson, true, documentdb_api_internal.bson_dollar_lookup_expression_eval_merge(collection.document, '{ "myvar" : "$a" }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)))
                           Index Searches: 0
(28 rows)

-- composite with partial $expr to the index
SELECT documentdb_api_internal.create_indexes_non_concurrently('exprdb', '{ "createIndexes": "exprcoll", "indexes": [ { "key": { "a": 1, "b": 1, "c": 1, "d": 1 }, "name": "abcd_1", "enableOrderedIndex": true }] }', TRUE);
                                                                                                   create_indexes_non_concurrently                                                                                                    
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 { "raw" : { "defaultShard" : { "numIndexesBefore" : { "$numberInt" : "3" }, "numIndexesAfter" : { "$numberInt" : "4" }, "createdCollectionAutomatically" : false, "ok" : { "$numberInt" : "1" } } }, "ok" : { "$numberInt" : "1" } }
(1 row)

EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb',
    '{ "find": "exprcoll", "filter": { "a": 5, "b": 5, "c": 5, "$expr": { "$and": [ { "$eq": [ "$f", "$g" ] }, { "$gt": [ "$d", 5 ] } ] } } }');
                                                                                                                          QUERY PLAN                                                                                                                           
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (DocumentDBApiExplainQueryScan)
   ->  Index Scan using abcd_1 on documents_201 collection
         Index Cond: ((document @= '{ "a" : { "$numberInt" : "5" } }'::bson) AND (document @= '{ "b" : { "$numberInt" : "5" } }'::bson) AND (document @= '{ "c" : { "$numberInt" : "5" } }'::bson) AND (document @> '{ "d" : { "$numberInt" : "5" } }'::bson))
         Filter: documentdb_api_internal.bson_dollar_expr(document, '{ "" : { "$and" : [ { "$eq" : [ "$f", "$g" ] }, { "$gt" : [ "$d", { "$numberInt" : "5" } ] } ] } }'::bson, '{ "now" : NOW_SYS_VARIABLE }'::bson)
(4 rows)

-- after adding a row with arrays, can no longer push down (multikey expr not supported)
SELECT documentdb_api.insert_one('exprdb', 'exprcoll', '{ "_id": "array", "a": [ 1, 2, 3 ] }');
                              insert_one                              
----------------------------------------------------------------------
 { "n" : { "$numberInt" : "1" }, "ok" : { "$numberDouble" : "1.0" } }
(1 row)

-- cannot push down any of these
set documentdb.forceDisableSeqScan to on;
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$eq": [ "$a", 10 ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:81: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$eq": [ 10, "$a" ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:82: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gt": [ "$a", 10 ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:84: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gt": [ 10, "$a" ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:85: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gte": [ "$a", 10 ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:87: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$gte": [ 10, "$a" ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:88: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lt": [ "$a", 10 ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:90: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lt": [ 10, "$a" ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:91: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lte": [ "$a", 10 ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:93: ERROR:  Could not find any valid index to push down for query
EXPLAIN (COSTS OFF) SELECT document FROM bson_aggregation_find('exprdb', '{ "find": "exprcoll", "filter": { "$expr": { "$lte": [ 10, "$a" ] } } }');
psql:sql/bson_expr_index_pushdown_tests.sql:94: ERROR:  Could not find any valid index to push down for query
